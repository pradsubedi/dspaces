#!/bin/bash -e
export PATH="@CMAKE_RUNTIME_OUTPUT_DIRECTORY@:${PATH}"

storage_mode=$2
storage_mode=${storage_mode:=server}

## Create dataspaces configuration file
echo "## Config file for DataSpaces
ndim = 3
dims = 256,256,256
max_versions = 8
max_readers = 8
lock_type = 2
num_apps = 2
" > dataspaces.conf

rm -rf conf.ds

if [ $1 -eq 1 ]; then
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 dspaces_server sockets &
        serverproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 1 test_writer 1 1 64 5 -s 8 -m $storage_mode -t &
        wproc=$!
        if [ $? != 0 ] ; then
            exit 1
        fi
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 1 terminator
        wait $serverproc || exit 1
        wait $wproc
elif [ $1 -eq 2 ]; then
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 dspaces_server sockets &
        serverproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 test_writer 1 2 64 5 -m $storage_mode -t &
        writerproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 test_reader 1 2 64 5 -t
        if [ $? != 0 ] ; then
            exit 1
        fi
        wait $serverproc || exit 1
        wait $writerproc
elif [ $1 -eq 3 ]; then
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 dspaces_server sockets &
        serverproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 test_writer 1 2 64 5 -s 8 -m $storage_mode -t &
        writerproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 test_reader 1 2 32 5 -s 8 -t
        if [ $? != 0 ] ; then
            exit 1
        fi
        wait $serverproc || exit 1
        wait $writerproc
elif [ $1 -eq 4 ]; then
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 dspaces_server sockets &
        serverproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 test_writer 1 2 64 5 -s 8 -m $storage_mode -t &
        writerproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 test_reader 1 2 64 2 -s 8 -t
        if [ $? != 0 ] ; then
            exit 1
        fi
        wait $writerproc || exit 1
        wait $serverproc
elif [ $1 -eq 5 ]; then
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 dspaces_server sockets &
        serverproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 test_reader 1 2 64 5 -s 8 -t &
        readerproc=$!
        sleep 7
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 test_writer 1 2 64 5 -s 8 -m $storage_mode -t
        if [ $? != 0 ] ; then
            exit 1
        fi
        wait $readerproc || exit 1
        wait $serverproc
elif [ $1 -eq 6 ]; then
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 1 dspaces_server sockets &
        serverproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 1 test_writer_f &
        writerproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 1 test_reader_f
        wait $writerproc
        wait $serverproc
elif [ $1 -eq 7 ]; then
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 dspaces_server sockets &
        serverproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 test_writer 1 2 64 5 -s 8 -m $storage_mode -t &
        writerproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 test_sub 1 2 64 5 -s 8 -t
        if [ $? != 0 ] ; then
            exit 1
        fi
        wait $serverproc || exit 1
        wait $writerproc
elif [ $1 -eq 8 ]; then
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 dspaces_server sockets &
        serverproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 test_writer 1 2 64 5 -s 8 -m $storage_mode -t &
        writerproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 test_reader 1 2 64 5 -s 8 -t -a
        if [ $? != 0 ] ; then
            exit 1
        fi
        wait $serverproc || exit 1
        wait $writerproc
elif [ $1 -eq 9 ]; then
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 1 test_writer_server sockets 1 1 64 5 -s 8 -m $storage_mode -t &
        wsproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 1 terminator
        if [ $? != 0 ] ; then
            exit 1
        fi
        wait $wsproc
elif [ $1 -eq 10 ]; then
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 test_writer_server sockets 1 2 64 5 -s 8 -m $storage_mode -t &
        writerproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 test_reader 1 2 64 5 -s 8 -t
        if [ $? != 0 ] ; then
            exit 1
        fi
        wait $writerproc
elif [ $1 -eq 11 ]; then
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 dspaces_server sockets &
        serverproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 4 test_writer_dyn 1 4 32 5 -m $storage_mode -t -i 1000:1000 -l 100:100:0 &
        writerproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 test_reader 1 2 64 5 -t
        if [ $? != 0 ] ; then
            exit 1
        fi
        wait $serverproc || exit 1
        wait $writerproc
elif [ $1 -eq 12 ]; then
        sed -i 's/max_versions = 8/max_versions = 30/' dataspaces.conf
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 dspaces_server sockets &
        serverproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 4 test_writer_dyn 2 2 2 32 32 30 -m $storage_mode -t -l 100:0:10 &
        writerproc=$!
        @MPIEXEC_EXECUTABLE@ @MPIEXEC_NUMPROC_FLAG@ 2 test_reader 2 1 2 64 32 30 -t
        if [ $? != 0 ] ; then
            exit 1
        fi
        wait $serverproc || exit 1
        wait $writerproc
fi
